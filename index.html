<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>After School Classes Checkout</title>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <!-- CSS styling for the cart icon -->
    <style>
      .cart-icon {
        position: fixed;
        top: 20px;
        right: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: black;
      }

      .cart-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: red;
        color: white;
        border-radius: 50%;
        padding: 5px 10px;
        font-size: 14px;
      }

      .error-message {
        color: red;
        font-size: 14px;
        margin-top: 5px;
        display: block;
      }

      input.error {
        border: 2px solid red;
        outline: none;
        border-radius: 4px;
      }

      /* Cart container layout */
      .cart-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: flex-start;
        width: 100%;
      }

      /* Individual cart items */
      .cart-item {
        display: flex;
        align-items: center;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      }

      .cart-item-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
      }

      .cart-item-details {
        flex-grow: 1;
      }

      .cart-item-details h3 {
        margin: 0;
        font-size: 18px;
      }

      .cart-item-details p {
        margin: 5px 0;
        font-size: 14px;
        color: #555;
      }

      .remove-btn {
        background-color: #ff4d4d;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }

      .remove-btn:hover {
        background-color: #ff0000;
      }
    </style>
  </head>
  <body>
    <div id="lessonStore">
      <!-- Main page content -->
      <div v-if="!showCheckoutForm">
        <h1>{{ message }}</h1>

        <!-- Search bar -->
        <input
          type="text"
          placeholder="Search lessons..."
          v-model="searchQuery"
          @input="searchLessons"
        />

        <!-- Sort options -->
        <div>
          <label for="sortAttribute">Sort by:</label>
          <select v-model="sortAttribute" id="sortAttribute">
            <option value="subject">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="spaces">Spaces</option>
          </select>
          <button @click="toggleSortOrder">
            Sort {{ sortOrder === 'asc' ? 'Ascending' : 'Descending' }}
          </button>
        </div>
      </div>

      <!-- Lessons Section -->
      <section v-if="!showCheckoutForm">
        <h2>Available Lessons</h2>
        <div :style="{ display: 'flex', flexWrap: 'wrap', gap: '20px' }">
          <div
            v-for="lesson in sortedFilteredLessons"
            :key="lesson.id"
            :style="{ flex: '1 1 200px', maxWidth: '250px', border: '1px solid black', padding: '10px' }"
          >
            <figure>
              <img
                :src="lesson.image"
                alt="lesson image"
                :style="{ width: '100%', height: 'auto' }"
              />
              <h2>{{ lesson.subject }}</h2>
              <p>Location: {{ lesson.location }}</p>
              <p>Price: ${{ lesson.price }}</p>
              <p>Spaces Left: {{ lesson.spaces }}</p>
            </figure>
            <button @click="addToCart(lesson)" :disabled="lesson.spaces === 0">
              Add to Cart
            </button>
          </div>
        </div>

        <!-- Cart Icon -->
        <div v-if="cart.length > 0" @click="showCheckoutPage" class="cart-icon">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-badge">{{ cart.length }}</span>
        </div>
      </section>

      <!-- Checkout Form Section -->
      <section v-if="showCheckoutForm">
        <h2>Your Cart</h2>
        <div
          v-for="(lesson, index) in cart"
          :key="lesson.id || index"
          class="cart-item"
        >
          <h3>{{ lesson.subject }}</h3>
          <p>Location: {{ lesson.location }}</p>
          <p>Price: ${{ lesson.price }}</p>
          <button @click="removeFromCart(lesson)">Remove from Cart</button>
        </div>

        <h2>Checkout</h2>
        <p>
          <strong>First Name:</strong>
          <input
            v-model="order.firstName"
            @blur="validateUsername"
            :class="{ error: usernameError }"
          />
          <span class="error-message" v-if="usernameError"
            >{{ usernameError }}</span
          >
        </p>

        <p>
          <strong>Phone Number:</strong>
          <input
            v-model="order.phone"
            @blur="validatePhone"
            :class="{ error: phoneError }"
          />
          <span class="error-message" v-if="phoneError">{{ phoneError }}</span>
        </p>

        <p><strong>Address:</strong> <input v-model="order.address" /></p>
        <button @click="submitOrder" :disabled="!isCheckoutValid">
          Place Order
        </button>
        <button @click="backToMainPage">Back to Lessons</button>
      </section>
    </div>

    <script>
      new Vue({
        el: "#lessonStore",
        data: {
          message: "Welcome to After School Classes Checkout",
          showCheckoutForm: false,
          cart: [],
          lessons: [],
          sortAttribute: "subject",
          sortOrder: "asc",
          searchQuery: "",
          order: {
            firstName: "",
            phone: "",
            address: "",
          },
          usernameError: "",
          phoneError: "",
        },
        computed: {
          sortedFilteredLessons() {
            let filteredLessons = this.lessons.filter((lesson) =>
              lesson.subject
                .toLowerCase()
                .includes(this.searchQuery.toLowerCase())
            );
            return filteredLessons.sort((a, b) => {
              let comparison =
                a[this.sortAttribute] > b[this.sortAttribute] ? 1 : -1;
              return this.sortOrder === "asc" ? comparison : -comparison;
            });
          },
          isCheckoutValid() {
            return (
              this.order.firstName &&
              this.order.phone &&
              !this.usernameError &&
              !this.phoneError
            );
          },
        },
        methods: {
          fetchLessons() {
            fetch("https://vue-app-backend.onrender.com/lessons")
              .then((response) => response.json())
              .then((data) => (this.lessons = data))
              .catch((error) =>
                console.error("Error fetching lessons from backend:", error)
              );
          },
          submitOrder() {
            fetch("https://vue-app-backend.onrender.com/order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: this.order.firstName,
                phone: this.order.phone,
                lessons: this.cart.map((lesson) => lesson.id),
              }),
            })
              .then((response) => response.json())
              .then(() => {
                alert("Order placed successfully!");
                this.resetCart();
                this.backToMainPage();
              })
              .catch((error) =>
                console.error("Error submitting order to backend:", error)
              );
          },
          addToCart(lesson) {
            if (lesson.spaces > 0) {
              this.cart.push({ ...lesson });
              lesson.spaces--;
            }
          },
          removeFromCart(lesson) {
            const index = this.cart.indexOf(lesson);
            if (index > -1) {
              this.cart.splice(index, 1);
              this.lessons.find((l) => l.id === lesson.id).spaces++;
            }
          },
          toggleSortOrder() {
            this.sortOrder = this.sortOrder === "asc" ? "desc" : "asc";
          },
          searchLessons() {
            this.searchQuery = this.searchQuery.trim();
          },
          showCheckoutPage() {
            this.showCheckoutForm = true;
          },
          backToMainPage() {
            this.showCheckoutForm = false;
          },
          resetCart() {
            this.cart.forEach((lesson) => {
              this.lessons.find((l) => l.id === lesson.id).spaces++;
            });
            this.cart = [];
          },
          validateUsername() {
            this.usernameError = !this.order.firstName.trim()
              ? "First name cannot be empty."
              : "";
          },
          validatePhone() {
            const phoneRegex = /^[0-9]{10,15}$/;
            this.phoneError = !phoneRegex.test(this.order.phone)
              ? "Phone number must be between 10 to 15 digits and contain numbers only."
              : "";
          },
        },
        mounted() {
          this.fetchLessons();
        },
      });
    </script>
  </body>
</html>
